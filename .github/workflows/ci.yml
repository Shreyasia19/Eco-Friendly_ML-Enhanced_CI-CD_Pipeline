name: Eco-CI

on:
  push:
  pull_request:

concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: ${{ secrets.DOCKER_REGISTRY || 'docker.io' }}/$GITHUB_REPOSITORY
  IMAGE_TAG: ${{ github.sha }}

jobs:

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    outputs:
      files_changed: ${{ steps.diff.outputs.files }}
    steps:
      - uses: actions/checkout@v4
      - name: Count files changed in PR/commit
        id: diff
        run: |
          # files changed heuristic (works on push/pull_request)
          FILES=$(git diff --name-only HEAD~1 HEAD || true)
          echo "files=$FILES"
          echo "::set-output name=files::${FILES}"
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install deps
        run: pip install -r app/requirements.txt
      - name: Run unit tests (demo)
        run: |
          python - <<'PY'
          python app/app.py

          PY

  check-carbon:
    name: Carbon check
    runs-on: ubuntu-latest
    outputs:
      intensity: ${{ steps.get.outputs.intensity }}
    steps:
      - name: Get carbon intensity (mock or real)
        id: get
        run: |
          # Use real API here if available; demo uses deterministic value
          # Example real API: curl -s "https://api.carbonintensity.org.uk/intensity"
          INTENSITY=150
          echo "intensity=$INTENSITY" >> $GITHUB_OUTPUT

  build-and-push:
    name: Build and push image
    runs-on: ubuntu-latest
    needs: [unit-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU and Docker Buildx
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
      - name: Log in to Docker Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.DOCKER_REGISTRY || 'docker.io' }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push
        run: |
          docker buildx build --push \
            --tag ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} \
            --cache-to type=inline --cache-from type=registry,ref=${{ env.IMAGE_NAME }}:cache || true

  predict:
    name: Predict heavy job
    runs-on: ubuntu-latest
    needs: [unit-tests]
    outputs:
      needs_heavy: ${{ steps.predict.outputs.heavy }}
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install small deps
        run: pip install joblib scikit-learn pandas
      - name: Download model (if stored as artifact) or use bundled dummy model
        run: |
          # For demo we'll use a simple heuristic: files_changed > 5 => heavy
          FILES="${{ needs.unit-tests.outputs.files_changed }}"
          if [ -z "$FILES" ]; then FILES_COUNT=1; else FILES_COUNT=$(echo "$FILES" | wc -w); fi
          if [ $FILES_COUNT -gt 5 ]; then echo "heavy=1" >> $GITHUB_OUTPUT; else echo "heavy=0" >> $GITHUB_OUTPUT; fi
        id: predict

  heavy-integration:
    name: Heavy integration tests (green-gated)
    runs-on: ubuntu-latest
    needs: [predict, check-carbon, build-and-push]
    if: ${{ fromJSON(needs.check-carbon.outputs.intensity) < 200 && needs.predict.outputs.needs_heavy == '1' }}
    steps:
      - uses: actions/checkout@v4
      - name: Run heavy tests (demo)
        run: |
          echo "Running heavy integration tests..."
          sleep 5
          echo "Heavy tests done."

  #deploy-to-k8s:
   # name: Deploy to Kubernetes
   # runs-on: ubuntu-latest
    #needs: [build-and-push]
    #steps:
     # - uses: actions/checkout@v4
     # - name: Set up Kubeconfig
     #   if: ${{ secrets.KUBE_CONFIG }}
      #  run: |
       #   echo "${{ secrets.KUBE_CONFIG }}" > kubeconfig
       #   mkdir -p $HOME/.kube
        #  mv kubeconfig $HOME/.kube/config
    #  - name: Install kubectl
     #   uses: azure/setup-kubectl@v3
      #- name: Deploy manifest
       # run: |
          # Replace with your manifest path
       #   kubectl apply -f k8s/deployment.yaml
