# .github/workflows/ci-cd.yml
name: CI/CD Pipeline (Eco-CI)

on:
  push:
    branches: [ "main" ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps & run tests
        working-directory: ./app
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pytest -q

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          IMAGE=${{ secrets.DOCKERHUB_USERNAME }}/eco-ci-app:${{ github.sha }}
          docker build -t $IMAGE .
          docker push $IMAGE
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

      - name: Update k8s manifest and kubectl apply
        env:
          IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/eco-ci-app:${{ github.sha }}
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG_DATA }}
        run: |
          echo "$KUBE_CONFIG_DATA" | base64 --decode > kubeconfig
          export KUBECONFIG=$PWD/kubeconfig
          # patch deployment image (if using 'latest' in manifest, you might kubectl set image)
          kubectl set image deployment/eco-ci-app eco-ci-app=$IMAGE --record || true
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
